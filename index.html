<!DOCTYPE html>
    <head>
        <meta charset="utf-8">
        <script src="https://d3js.org/d3.v3.min.js"></script>
        <script src="https://d3js.org/topojson.v1.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script src="d3.promise.js"></script>
        <script src="q.js"></script>
    </head>
    <body>

        <script>
            var width = 1024,
                height = 800,
                projection,
                sates,
                path;

            var svg = d3.select("body").append("svg")
                .attr("width", width)
                .attr("height", height);

            d3.json("muc.json", function(error, raw) {

                if (error) throw error;

                states = topojson.feature(raw, raw.objects.states);

                // Setup the scale and translate

                projection = d3.geo.mercator();
                projection.scale(1).translate([0, 0]);

                path = d3.geo.path().projection(projection);

                var b = path.bounds(states);

                var s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height);
                var t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];

                projection = projection.scale(s).translate(t);

                //Color scale
                var color = d3.scale.linear().domain([0,25]).range(['orange', 'green']);

                var map = svg.append('g').attr('class', 'boundary');
                var munich = map.selectAll('path').data(states.features);

                //Enter
                munich.enter()
                    .append('path')
                    .attr('d', path)
                    .attr('fill', function(d,i) {return color(i)});

            });

            var bikesTaken = new Array();

            var bikeData = new Array();

            Q.all([d3.promise.json("rad1.json").then(function (raw) {
                bikeData[0] = raw;
            }),

            d3.promise.json("rad2.json").then(function (raw) {
                bikeData[1] = raw;
            }),

            d3.promise.json("rad3.json").then(function (raw) {
                bikeData[2] = raw;
            }),

            d3.promise.json("rad4.json").then(function (raw) {
                bikeData[1] = raw;
            })]).then(function (value) {

                bikeData.forEach(function (element, index, array) {
                    if (index === array.length-1) {
                        return;
                    }
                    console.log(index, element);
                    element.sta.forEach(function (bike) {
                        var nextIterBikes = array[index+1].sta.filter(function(elem) {
                            return elem.id === bike.id;
                        });
                        if (!nextIterBikes.length) {
                            console.log(bike.id);
                            bikesTaken.push(bike);
                        }
                    });
                });

                svg.append('g').selectAll("circle")
                    .data(bikesTaken)
                    .enter()
                    .append('circle')
                    .attr('cx', function(d) {
                        d.loc.reverse();
                        return projection(d.loc)[0];
                    })
                    .attr('cy', function(d) {
                        return projection(d.loc)[1];
                    })
                    .attr('r', '5')
                    .attr('fill', "#fff")
                    .attr('opacity', 1);
            });

            </script>
    </body>
</html>
